@page "/quiz-dashboard"
@using kahoot_app.WebUI.Components.Layout

@inject NavigationManager NavigationManager

<PageTitle>Quiz Dashboard</PageTitle>

<div class="container">
    <div class="row">

    
        <h1>Welcome to Quiz Management Dashboard</h1>
        <div class="col-8">
            <div class="mt-5 p-2 mb-6">
                <h3>Hello @quiz.Admin.Name ! Your're Managing the quiz.</h3>
                <h4>Your Quiz is : <em> @quiz.QuizName </em></h4>
            </div>

            <div class="row mt-4 p-2">
            @* REQ#3.1.3 *@
            <h5> Current Participants: <em>(@playerList.Count)</em></h5>
            @foreach (var player in playerList)
            {
                <div class="col-3 text-center">
                    <div class="card p-4"> @player.Name </div>
                </div>
            } 
            </div>
            @if(!quizStartedDashboard){
                <div class="d-flex justify-content-end">
                    <div style="margin-right: 100px;">
                        <button class="btn btn-primary mt-4" disabled="@(!CanStartQuiz)" @onclick="StartQuiz">Start Quiz Now</button>
                    </div>
                
                </div>
            } else{
                
                <div class="shadow p-5 border-rounded boxed">
                    <h4 class="text-center"> @quizQuestions.GetQuestion(currentQuestionNum-1) </h4>
                    <div class="row">
                        @foreach(var item in quizQuestions.GetOptions(currentQuestionNum-1)){
                        <div class="col-6">
                            <div class="inner card">
                                No. @currentQuestionNum 
                                @item.Item2
                            </div>
                        </div>
                          }
                    </div>
                </div>
              
                 <button class="btn btn-primary mt-4 ml-auto" @onclick="ChangeQuizQuestion">Next Question</button>
                
            }
        </div>
    
        <div class="col-4">
            @if(quizStartedDashboard){
            <LeaderboardData LeaderboardPlayers="@leaderboardPlayersList" />
            }
        </div>

    </div>

</div>
@code {

    [SupplyParameterFromQuery]
    public int? QuizId { get; set; }
    bool adminAdded = false;
    int answer;
    bool quizStartedDashboard;

    bool CanStartQuiz;

    string adminName;
    Questions? quizQuestions;

    int currentQuestionNum =0;

    void ChangeQuizQuestion(){
        quiz.ChangeQuestion();
    }

    List<(int, string, int)> leaderboardPlayersList = new();

    List<(string, List<(int, bool, string)>)> quizQuestionList = new();
    List<Player> playerList = new();

    

    Quiz? quiz
    {
        get
        {
            if (QuizId is null)
                return null;

            try
            {
                return QuizHost.Instance.Quizzes[QuizId.Value - 1];
            }
            catch
            {
                NavigationManager.NavigateTo("/");
            }
            return null;
        }

    }

    void StartQuiz(){

        quiz.Start();
        

    }
    protected override void OnInitialized()
    {
        @* REQ#4.1.2 *@
        leaderboardPlayersList = Leaderboard.LeaderboardPlayers;
        quiz.getQuestions();
        quizQuestions = quiz.Questions;
        quizQuestionList = quizQuestions.QuestionsList;
        currentQuestionNum = quiz.CurrentQuestionNumber;
        quiz.QuizStateChanged += () => InvokeAsync(StateHasChanged);

    }
    protected override void OnParametersSet()
    {
        quiz.QuizStateChanged += () =>
        {
            InvokeAsync(() =>
            {
                @* REQ#3.1.3 *@
                playerList = quiz.Players;
                currentQuestionNum = quiz.CurrentQuestionNumber;
                leaderboardPlayersList = Leaderboard.LeaderboardPlayers;
                CanStartQuiz = playerList.Count > 0;
                StateHasChanged();
            });
        };
        quiz.QuizStarted += () =>
        {
            InvokeAsync(() =>
            {
                @* REQ#3.1.3 *@
                quizStartedDashboard = true;
                currentQuestionNum = quiz.CurrentQuestionNumber;
                StateHasChanged();
            });
        };
         quiz.QuestionChangedEvent += () => {
            InvokeAsync(() =>
            {
                currentQuestionNum = quiz.CurrentQuestionNumber;
                StateHasChanged();
            });
           
        };


    }

}
